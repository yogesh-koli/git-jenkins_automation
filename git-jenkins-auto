pipeline {
    agent any
    parameters {
        string(name: 'TAG_NAME', defaultValue: '', description: 'Enter the tag name')
        string(name: 'BRANCH_NAME', defaultValue: 'master', description: 'Enter the branch name')
    }

    environment {
        GIT_HOME = "/home/yogesh-koli/git"
        GIT_URL = "https://yogesh-koli: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@github.com/yogesh-koli/git-jenkins_automation"
    }

    stages {
        stage('Pull and push from GitHub') {
            steps {
                script {
                    sh '''
                        whoami
                        cd /dir2/
                        ls -lsrt
                        git config --global --add safe.directory /dir2
                        git branch
                        git stash
                    '''
                    if (BRANCH_NAME == "master") {
                        sh 'git pull origin master'
                    } else {
                        sh "git pull $GIT_URL"
                    }
                }
            }
        }

        stage('Git checkout') {
            steps {
                script {
                    sh '''
                        cd /dir2/
                        if [ "$BRANCH_NAME" != "master" ]; then
                            git checkout $BRANCH_NAME
                        fi
                    '''
                }
            }
        }

        stage('Pull and push from GitHub (master Branch)') {
            steps {
                sh '''
                    cd /dir2/
                    git pull origin master
                '''
            }
        }

        stage('Create and push a tag') {
            steps {
                script {
                    def tagName = params.TAG_NAME.trim()

                    if (tagName) {
                        sh '''
                            cd /dir2/
                            echo $tagName
                            git tag -a $tagName -m "$tagName"
                            git pull $GIT_URL
                            git push $GIT_URL --tags
                        '''
                    } else {
                        error('Tag name not provided. Tagging aborted.')
                    }
                }
            }
        }

        stage('Pull a tag') {
            steps {
                sh '''
                    cd /dir2/
                    git fetch --tags
                    git checkout ${params.TAG_NAME}
                '''
            }
        }
    }
}
